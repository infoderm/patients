name: ci:snyk

on:
  push:
    branches:
      - main
  pull_request:
  schedule:
    - cron: '0 2 * * 0'

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  security:

    runs-on: ubuntu-latest
    timeout-minutes: 10

    environment: Snyk

    steps:

      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v3

      - name: Run Snyk ğŸº
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --sarif-file-output=snyk.sarif

      - name: Upload result to GitHub Code Scanning ğŸ“®
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: snyk.sarif

      - name: Parse SARIF report ğŸ“ƒ
        run: |
          echo VULNERABILITIES="$(< snyk.sarif jq "[.runs[] | .results | length] | add")" >> $GITHUB_ENV

      - name: Fail if PR and Snyk reported vulnerabilities ğŸ’¥
        if: github.event_name == 'pull_request' && env.VULNERABILITIES >= 1
        uses: actions/github-script@v6
        with:
          script: |
              core.setFailed('Failing job because Snyk reported ${{ env.VULNERABILITIES }} vulnerabilities and we are a PR.')
